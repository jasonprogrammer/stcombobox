/** @license STComboBox (c) 2015 Jason Jones (simpletutorials.com), MIT License

 debounce() and now() functions from:
 Underscore.js 1.7.0
 http://underscorejs.org
 (c) 2009-2014 Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
 Underscore may be freely distributed under the MIT license.

 A filtering method by sod (a user) on http://stackoverflow.com/a/3976066 was also used
 */
var STComboBox=function(t){var e=function(){},i=function(e){return t("#"+e)},s={up:38,down:40,enter:13},o=Date.now||function(){return(new Date).getTime()},n=function(t,e,i){var s,n,l,d,r,c=function(){var h=o()-d;e>h&&h>0?s=setTimeout(c,e-h):(s=null,i||(r=t.apply(l,n),s||(l=n=null)))};return function(){l=this,n=arguments,d=o();var h=i&&!s;return s||(s=setTimeout(c,e)),h&&(r=t.apply(l,n),l=n=null),r}};return e.prototype.Init=function(e){this.containerId=e;var s=i(e);s.html(this.getHtml(e));var o=this;s.find(".stc-button").on("click",function(t){t.stopPropagation(),o.toggleList(),o.filterAndResetSelected()}),t(document).on("click",function(){o.hideList()}),this.getInput().on("keydown",function(t){o.onKeyDown(t)}).on("focus",function(t){o.onFocus(t)}).on("click",function(t){t.stopPropagation()})},e.prototype.filterAndResetSelected=function(){""==this.$("ddi").val()?this.selectRow(0):(this.filterList(this.$("ddi").val()),this.$("ddl").scrollTop(0),this.selectedIndex=0)},e.prototype.onFocus=function(){this.showList(),this.filterAndResetSelected()},e.prototype.onKeyDown=function(e){if(e.which==s.enter){var i=this.getVisibleDomRows(),o=1*t(i[this.selectedIndex]).attr("data-stc-id");return this.$("ddi").val(this.data[o].text),this.hideList(),!1}return e.which==s.down?(this.selectedIndex<this.visibleRows.length-1&&(this.deselectRow(),this.selectRow(++this.selectedIndex)),!1):e.which==s.up?(e.stopPropagation(),this.selectedIndex>0?(this.deselectRow(),this.selectRow(--this.selectedIndex)):this.deselectRow(-1),!1):void this.showAndFilterList()},e.prototype.showAndFilterList=n(function(){this.showList(),this.deselectRow(),this.filterList(this.getInput().val()),this.selectedIndex=-1},200),e.prototype.$=function(t){return i(this.containerId+"-"+t)},e.prototype.deselectRow=function(e){t(this.getVisibleDomRows()[this.selectedIndex]).removeClass("stc-lrow-hl"),e&&(this.selectedIndex=e)},e.prototype.selectRow=function(e){var i=this.getVisibleDomRows();if(!(0==i.length||e>=i.length)){t(i[e]).addClass("stc-lrow-hl"),this.selectedIndex=e;var s=this.$("ddl");if(0==e)return console.log(s),void s.scrollTop(0);var o=s.scrollTop(),n=s.height(),l=o+n,d=t(i[e]),r=d.outerHeight(),c=d.position();console.log("scroll top: "+o+"; rowTop: "+c.top),c.top<o&&(console.log("moving up to: "+c.top),s.scrollTop(c.top)),c.top+r>l&&s.scrollTop(o+r)}},e.prototype.filterList=function(e){for(var i=this.getFilteredRows(e),s=this.getDomRows(),o=0,n=0;o<s.length;o++)t(s[o]).toggle(o in i).removeClass("stc-lrow-odd").toggleClass("stc-lrow-odd",n%2==1),o in i&&n++},e.prototype.getDomRows=function(){return this.$("ddlt")[0].rows},e.prototype.getVisibleDomRows=function(){return this.visibleRows},e.prototype.getFilteredRows=function(t){var e=new RegExp("(\\d+)`([^#]*"+t+"[^#]*)#","gi"),i={},s=null;this.visibleRows=[];for(var o=this.getDomRows();s=e.exec(this.filterCache);){var n=1*s[1];this.visibleRows.push(o[n]),i[n]=0}return i},e.prototype.hideList=function(){this.$("ddl").hide()},e.prototype.showList=function(){var t=this.$("ddt"),e=t.position(),i=t.outerHeight()+e.top,s=2;this.$("ddl").css({top:i+"px",left:e.left,width:this.$("ddb").width()-s+"px"}).show()},e.prototype.toggleList=function(){return this.$("ddl").is(":visible")?void this.hideList():void this.showList()},e.prototype.populateList=function(e){this.data=e,this.filterCache="";for(var i=0;i<e.length;i++)this.filterCache+=i+"`"+e[i].text+"#";var s=this.$("ddl");s.html(this.getListHtml(e));var o=this;s.find(".stc-lrow").hover(function(){t(this).addClass("stc-lrow-hover")},function(){t(this).removeClass("stc-lrow-hover")}).on("click",function(){var e=1*t(this).attr("data-stc-id");o.getInput().val(o.data[e].text)}),this.visibleRows=this.getDomRows(),this.selectedIndex=-1},e.prototype.getInput=function(){return this.$("ddi")},e.prototype.getListHtml=function(t){for(var e=this.containerId,i='<table cellspacing="0" cellpadding="0" class="stc-ltable" id="'+e+'-ddlt">',s=0;s<t.length;s++){var o=t[s],n=s%2?"stc-lrow-odd":"";i+='<tr class="stc-lrow '+n+'" data-stc-id="'+o.id+'" id="'+e+'-ddlrow"><td><span class="stc-text" id="'+e+"-ddtext"+s+'">'+o.text+"</span></td></tr>"}return i+="</table>"},e.prototype.getHtml=function(t){return'<span class="stc-box" id="'+t+'-ddb"><table cellspacing="0" cellpadding="0" class="stc-table" id="'+t+'-ddt"><tr> <td><input type="text" class="stc-input" id="'+t+'-ddi"/></td> <td class="stc-button"></td></tr></table><div id="'+t+'-ddl" class="stc-lc" style="display: none"></div></span>'},e}($);